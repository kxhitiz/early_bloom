<div class="max-w-3xl mx-auto">
  <% if logged_in? && current_user.child_profiles.any? %>
    <%= link_to "← Back to Feed", feed_path, class: "text-emerald-600 hover:text-emerald-700 mb-6 inline-block" %>
  <% else %>
    <%= link_to "← Back to Posts", posts_path, class: "text-emerald-600 hover:text-emerald-700 mb-6 inline-block" %>
  <% end %>

  <article class="bg-white p-8 rounded-lg shadow-sm border border-stone-200 mb-8">
    <div class="flex items-start justify-between mb-6">
      <div class="flex items-center gap-3">
        <%= link_to user_path(@post.user), class: "w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-700 font-bold text-xl hover:bg-emerald-200 transition" do %>
          <%= @post.user.name.first.upcase %>
        <% end %>
        <div>
          <%= link_to @post.user.name, user_path(@post.user), class: "font-bold text-lg text-stone-800 hover:text-emerald-700" %>
          <p class="text-sm text-stone-500">
            <%= @post.child_profile.name %> · <%= @post.child_profile.age_in_months %> months old ·
            <%= time_ago_in_words(@post.published_at) %> ago
          </p>
        </div>
      </div>
      <div class="flex flex-col items-end gap-1">
        <% if @post.category %>
          <span class="text-sm px-3 py-1 bg-stone-100 text-stone-600 rounded-full">
            <%= @post.category.icon %> <%= @post.category.name %>
          </span>
        <% end %>
        <span class="text-sm px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full font-medium">
          <%= @post.post_type %>
        </span>
      </div>
    </div>
    
    <% if @post.title.present? %>
      <h1 class="text-3xl font-bold text-stone-800 mb-4"><%= @post.title %></h1>
    <% end %>
    
    <div class="text-stone-700 text-lg leading-relaxed mb-6">
      <%= simple_format(@post.body) %>
    </div>

    <% if @post.post_type == "question" && @post.ai_answer.present? %>
      <div class="bg-white rounded-2xl p-5 mb-6 shadow-[0_2px_16px_-4px_rgba(139,92,246,0.18)]">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center">
            <span class="text-white text-sm">✨</span>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-1 mb-2">
              <span class="font-semibold text-violet-600">Bloom AI</span>
            </div>
            <div class="text-slate-700 leading-relaxed">
              <%= simple_format(@post.ai_answer) %>
            </div>
            <p class="mt-4 text-xs text-slate-400">
              Always consult your pediatrician for medical advice.
            </p>
          </div>
        </div>
      </div>
    <% end %>

    <% if logged_in? && current_user == @post.user %>
      <div class="pt-4 border-t border-stone-200 flex items-center gap-4">
        <%= link_to "Edit Post", edit_post_path(@post), class: "text-emerald-600 hover:text-emerald-700 font-medium" %>
        <%= button_to "Delete Post", post_path(@post), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this post? This cannot be undone." }, class: "text-red-600 hover:text-red-700 font-medium" %>
      </div>
    <% end %>
  </article>

  <!-- Reactions Section -->
  <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 mb-8">
    <h3 class="font-semibold text-stone-800 mb-4">Show your support</h3>
    
    <div class="flex gap-3 flex-wrap">
      <% ['helpful', 'reassuring', 'relatable', 'celebrate'].each do |reaction_type| %>
        <% count = @post.reactions.where(reaction_type: reaction_type).count %>

        <% if logged_in? %>
          <% user_reaction = @post.reactions.find_by(user: current_user, reaction_type: reaction_type) %>
          <% if user_reaction %>
            <%= button_to post_reaction_path(@post, user_reaction), method: :delete, class: "px-4 py-2 bg-emerald-100 border-2 border-emerald-600 text-emerald-700 rounded-lg font-medium hover:bg-emerald-200" do %>
              <%= reaction_emoji(reaction_type) %> <%= reaction_type.humanize %> (<%= count %>)
            <% end %>
          <% else %>
            <%= button_to post_reactions_path(@post), params: { reaction: { reaction_type: reaction_type } }, class: "px-4 py-2 bg-white border border-stone-300 text-stone-600 rounded-lg font-medium hover:bg-stone-50" do %>
              <%= reaction_emoji(reaction_type) %> <%= reaction_type.humanize %> <%= "(#{count})" if count > 0 %>
            <% end %>
          <% end %>
        <% else %>
          <span class="px-4 py-2 bg-stone-50 border border-stone-200 text-stone-500 rounded-lg font-medium">
            <%= reaction_emoji(reaction_type) %> <%= reaction_type.humanize %> <%= "(#{count})" if count > 0 %>
          </span>
        <% end %>
      <% end %>
    </div>
    <% unless logged_in? %>
      <p class="text-stone-500 mt-3 text-sm"><%= link_to "Login", login_path, class: "text-emerald-600 hover:text-emerald-700" %> to add your reaction</p>
    <% end %>
  </div>

  <!-- Comments Section -->
  <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
    <h2 class="text-2xl font-bold text-stone-800 mb-6">
      Comments (<%= @comments.count %>)
    </h2>

    <% if logged_in? %>
      <%= form_with model: [@post, Comment.new], class: "mb-8" do |f| %>
        <%= f.text_area :body, rows: 4, class: "w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 mb-3", placeholder: "Share your thoughts, experience, or support..." %>
        <%= f.submit "Add Comment", class: "px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold cursor-pointer" %>
      <% end %>
    <% else %>
      <p class="mb-8 text-stone-500">
        <%= link_to "Login", login_path, class: "text-emerald-600 hover:text-emerald-700 font-medium" %> to comment
      </p>
    <% end %>

    <div class="space-y-6">
      <% @comments.each do |comment| %>
        <div class="border-l-4 border-emerald-200 pl-4">
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
              <%= link_to user_path(comment.user), class: "w-8 h-8 bg-stone-200 rounded-full flex items-center justify-center text-stone-600 font-semibold text-sm hover:bg-stone-300 transition" do %>
                <%= comment.user.name.first.upcase %>
              <% end %>
              <div>
                <%= link_to comment.user.name, user_path(comment.user), class: "font-semibold text-stone-800 hover:text-emerald-700" %>
                <p class="text-xs text-stone-500"><%= time_ago_in_words(comment.created_at) %> ago</p>
              </div>
            </div>
            
            <% if logged_in? && current_user == comment.user %>
              <%= button_to "Delete", post_comment_path(@post, comment), method: :delete, data: { confirm: "Are you sure?" }, class: "text-xs text-red-600 hover:text-red-700" %>
            <% end %>
          </div>
          
          <p class="text-stone-700"><%= simple_format(comment.body) %></p>
        </div>
      <% end %>

      <% if @comments.empty? %>
        <p class="text-stone-500 text-center py-8">No comments yet. Be the first to respond!</p>
      <% end %>
    </div>
  </div>
</div>
